name: Auto Approve and Merge Releases

on:
  pull_request:
    types:
      - opened
      - edited

jobs:
  auto-approve-merge-releases:
    name: Automatically approve and merge release PRs generated by Jenkins
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v4

      - name: ❓ Check if pull request is eligible for auto-approval and merge
        id: check_pr_title
        run: |
          if [[ "${{ github.event.pull_request.user.login }}" == "${USERNAME}" && "${{ github.event.pull_request.title }}" =~ ^Release[[:space:]](0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-((0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*)(\.(0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*))*))?(\+([0-9a-zA-Z-]+(\.[0-9a-zA-Z-]+)*))?$ ]]; then
              echo "eligible=true" >> $GITHUB_OUTPUT
          else
              echo "eligible=false" >> $GITHUB_OUTPUT
          fi
        env:
          USERNAME: "roger-schaer"

      - name: ✅︎ Auto-approve and merge pull request
        if: steps.check_pr_title.outputs.eligible == 'true'
        run: |
          gh pr review ${{ github.event.pull_request.number }} --approve
          gh pr merge ${{ github.event.pull_request.number }} --squash --auto
        env:
          GH_TOKEN: ${{ github.token }}
